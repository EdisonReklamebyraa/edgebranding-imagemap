(function(s){"use strict";const y=(t,e)=>{const o=t.__vccOpts||t;for(const[r,n]of e)o[r]=n;return o},w={mixins:[Fieldtype],data(){return{zoom:!1,selectedDropdown:"showAll",entryMeta:[],loading:!1,polygons:[],images:[],selectedImage:null}},computed:{entriesWithMeta(){return this.value.entries.map(t=>this.entryMeta.find(e=>e.id===t))}},methods:{onImageUploaded(t){this.update({...this.value,images:t});let e=[];const o=this;Promise.all(t.map(r=>o.getImage(r))).then(r=>{r.forEach(n=>{e.push(n[0])}),o.images=e,o.selectedImage=e[0].id,o.updatePolygonList()})},onEntriesUpdated(t){this.update({...this.value,entries:t}),this.$nextTick(()=>{this.updatePolygonList()})},getImage(t){return this.$axios.post(cp_url("assets-fieldtype"),{assets:t}).then(e=>e.data)},activateZoomMode(){this.zoom=!this.zoom},updatePolygonList(){if(!this.value.entries){this.value.entries=[];return}const t=this.value.entries.flatMap(e=>{const o=this.entriesWithMeta.find(r=>r.id===e);return this.value.images.map(r=>{const n=this.value.items.find(i=>i.entryId===e&&i.assetId===r);return n||{entryId:e,assetId:r,label:o.title,polygon:""}})});this.update({...this.value,items:t}),this.polygons=t},updatePolygon(t){const e=this.value.items;let o=e.findIndex(r=>r.entryId===t.entryId&&r.assetId===t.assetId);e[o].polygon=t.polygon,this.update({...this.value,items:e})},updateZoom(t){this.zoom=t},loadEntryMeta(){const t={config:btoa(JSON.stringify({handle:"collections",type:"entries",collections:this.config.collections,mode:"tags"})),value:this.value.entries};this.loading=!0,this.$axios.get(cp_url("fields/field-meta"),{params:t}).then(e=>{this.entryMeta=e.data.meta.data,this.loading=!1,this.updatePolygonList()})}},mounted(){this.loadEntryMeta(),this.value.items||this.update({...this.value,items:[]})}},x={class:"flex flex-wrap gap-1"},E={class:"publish-field-label mb-1"},I=["innerHTML"],O={key:0,class:"imagemapeditor mx-auto w-full mt-4"},k={class:"publish-field-label mb-1"},_=["innerHTML"],b={class:"flex"},V={class:"flex-initial control mb-1 mr-1 field select-input"},B=["innerHTML"],v={id:"editor"};function P(t,e,o,r,n,i){const l=s.resolveComponent("assets-fieldtype"),a=s.resolveComponent("publish-field-meta"),c=s.resolveComponent("relationship-fieldtype"),m=s.resolveComponent("v-select"),d=s.resolveComponent("svg-edit");return s.openBlock(),s.createElementBlock("div",null,[s.createElementVNode("div",x,[s.createVNode(a,{config:{type:"assets"},"initial-value":t.value.images,"initial-meta":{container:t.config.container},class:"w-1/2 mr-2 assets-fieldtype"},{default:s.withCtx(({meta:h,value:p,loading:u})=>[s.createElementVNode("div",null,[e[5]||(e[5]=s.createElementVNode("label",{class:"publish-field-label mb-1"},[s.createElementVNode("span",{class:"cursor-pointer"},"Image")],-1)),u?s.createCommentVNode("",!0):(s.openBlock(),s.createBlock(l,{key:0,config:{container:t.config.container,mode:"grid",allow_uploads:!0,type:"assets",display:"assets",component:"assets",handle:"assets"},value:p,meta:h,handle:"asset",ref:"asset",onInput:i.onImageUploaded},null,8,["config","value","meta","onInput"]))])]),_:1},8,["initial-value","initial-meta"]),s.createVNode(a,{config:{handle:"collections",type:"entries",collections:t.config.collections,mode:"tags"},"initial-value":t.value.entries,class:"w-1/2 flex-1"},{default:s.withCtx(({meta:h,value:p,loading:u})=>[s.createElementVNode("div",null,[s.createElementVNode("label",E,[s.createElementVNode("span",{class:"cursor-pointer",innerHTML:t.__("Buildings")},null,8,I)]),u?s.createCommentVNode("",!0):(s.openBlock(),s.createBlock(c,{key:0,config:{handle:"collections",type:"entries",collections:t.config.collections,mode:"tags"},value:p,meta:h,handle:"entry",ref:"entry",onInput:i.onEntriesUpdated,onMetaUpdated:e[0]||(e[0]=U=>n.entryMeta=U.data)},null,8,["config","value","meta","onInput"]))])]),_:1},8,["config","initial-value"])]),n.loading?s.createCommentVNode("",!0):(s.openBlock(),s.createElementBlock("div",O,[s.createElementVNode("label",k,[s.createElementVNode("span",{class:"cursor-pointer",innerHTML:t.__("Editor")},null,8,_)]),s.createElementVNode("div",b,[s.createElementVNode("div",V,[s.createElementVNode("button",{class:s.normalizeClass(["btn",n.zoom?"btn-primary":""]),onClick:e[1]||(e[1]=h=>i.activateZoomMode()),innerHTML:t.__("Forstørr område")},null,10,B)]),s.createVNode(m,{class:"w-full mr-1",options:n.images.map(h=>h===void 0?null:{value:h.id,label:h.values.alt||h.filename}).filter(h=>h!==null),reduce:h=>h.value,clearable:!1,modelValue:n.selectedImage,"onUpdate:modelValue":e[2]||(e[2]=h=>n.selectedImage=h)},null,8,["options","reduce","modelValue"]),s.createVNode(m,{class:"w-full",options:[{value:"showAll",label:t.__("Velg eiendom / vis alle")}].concat(i.entriesWithMeta.map(h=>h===void 0?null:{value:h.id,label:h.title}).filter(h=>h!==null)),reduce:h=>h.value,clearable:!1,modelValue:n.selectedDropdown,"onUpdate:modelValue":e[3]||(e[3]=h=>n.selectedDropdown=h)},null,8,["options","reduce","modelValue"])]),s.createElementVNode("div",v,[n.polygons.length&&n.images.length>0?(s.openBlock(),s.createBlock(d,{key:0,onPolygonUpdated:i.updatePolygon,onZoomUpdated:i.updateZoom,selected:n.selectedDropdown,"onUpdate:selected":e[4]||(e[4]=h=>n.selectedDropdown=h),polygons:n.polygons,"zoom-enabled":n.zoom,images:n.images,"selected-image":n.selectedImage},null,8,["onPolygonUpdated","onZoomUpdated","selected","polygons","zoom-enabled","images","selected-image"])):s.createCommentVNode("",!0)])]))])}const X=y(w,[["render",P]]);class g{constructor(e,o){this.x=e,this.y=o}}class Y{getLineLength(e,o,r,n){return Math.sqrt((r-e)**2+(n-o)**2)}getAngle(e,o){const r=o.x-e.x,n=o.y-e.y;let i=Math.atan2(-n,r);return i<0&&(i+=2*Math.PI),i}rotate(e,o,r){const n=Math.cos(r),i=Math.sin(r);let l=o.x*n-o.y*i,a=o.y*n+o.x*i;return new g(l,a)}pointIntersectsLine(e,o,r,n){const i=new g(0,0),l=this.getAngle(o,r),a=this.rotate(i,r,l),c=this.rotate(i,o,l),m=this.rotate(i,e,l);return m.x<=Math.max(c.x,a.x)&&m.x>=Math.min(c.x,a.x)&&m.y<=c.y+n/2&&m.y>=a.y-n/2}}const M=new Y,f={VIEW_MODE:0,PAN_MODE:1,BEFORE_ZOOM_MODE:2,ZOOM_MODE:3,MOVE_POINT:4,EDIT_EDGE_MODE:5};Object.freeze(f);const D={watch:{polygon(){if(!this.currentEntryId)return;this.polygonCollection[this.currentEntryId].polygon=this.polygon;const t={entryId:this.currentEntryId,assetId:this.selectedImage,polygon:this.polygon};this.$emit("polygon-updated",t)},zoomEnabled(){this.zoomEnabled?this.setZoomMode(this.Modes.BEFORE_ZOOM_MODE):this.setZoomMode(this.Modes.VIEW_MODE)},selected(){this.setActiveObject(this.selected)},selectedImage(){this.setPolygonCollection(),this.setActiveObject(this.selected),!(!this.images.length>0)&&this.setImage(this.selectedImage)},images(){this.setPolygonCollection(),this.setActiveObject(this.selected),!(!this.images.length>0)&&this.setImage(this.selectedImage)}},mounted(){window.addEventListener("keyup",this.keyHandler),this.setImage(this.selectedImage),this.setPolygonCollection(),this.setActiveObject(this.selected)},name:"SvgEdit",props:{images:String,selectedImage:String,zoomEnabled:Boolean,selected:String,polygons:Array},computed:{viewboxStyle(){return`0 0 ${this.viewBox.width} ${this.viewBox.height} `},backgroundStyle(){let t=`transform: translateX(${this.translateX}px) `;return t+=`translateY(${this.translateY}px) scale(${this.zoom});`,t+=`background-image: url(${this.img})`,t},polygon(){return this.points.map(t=>t.join(",")).join(" ")},getCurrentMode(){return parseInt(this.currentMode,10)},showAll(){return this.currentEntryId==="showAll"||!this.currentEntryId}},data:function(){return{currentFill:0,fills:["rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)"],img:"",imgIsReady:!1,viewBox:{factor:1,width:0,height:0},mouseDown:!1,delta:0,hasPanned:!1,panThreshold:8,target:null,Modes:f,currentMode:f.VIEW_MODE,activePoint:-1,selection:{startX:0,startY:0,x:0,y:0,width:0,height:0},factor:.8,oldOffsetX:0,oldOffsetY:0,offsetX:0,offsetY:0,points:[],maxZoom:5,translateX:0,translateY:0,zoom:1,hoveringVertex:!1,polygonCollection:{},currentEntryId:null,height:0}},methods:{setPolygonCollection(){let t={};this.polygons.filter(e=>e.assetId===this.selectedImage).map(e=>{t[e.entryId]=e}),this.polygonCollection=t},randomFill(t){let e=Object.keys(this.polygonCollection).indexOf(t);for(e===-1&&(e=0);e>this.fills.length-1;)e=e-this.fills.length;return this.fills[e]},setActiveObjectDelegate(t){this.currentMode!==this.Modes.PAN_MODE&&this.setActiveObject(t)},setActiveObject(t){if(t==="showAll"){this.currentEntryId=null,this.points=[];return}if(this.currentEntryId=t,this.polygonCollection[t]||(this.polygonCollection[t]={}),this.polygonCollection[t].polygon){let e=this.polygonCollection[t].polygon;e=e.split(" ").map(o=>o.split(",")),this.points=e}else this.points=[];this.$emit("update:selected",this.currentEntryId)},keyHandler(t){t.key==="z"&&(this.currentMode=this.Modes.BEFORE_ZOOM_MODE)},mousedownHandler(t){if(this.mouseDown=!0,this.currentMode===this.Modes.BEFORE_ZOOM_MODE){this.currentMode=this.Modes.ZOOM_MODE,this.startSelectionZoom(t);return}if(t.target.tagName==="circle"?this.target="circle":this.target=t.target.getAttribute("id"),this.target==="circle")return t.shiftKey?this.removePoint(t.target.getAttribute("idx")):(this.currentMode=this.Modes.MOVE_POINT,this.startMovePoint(t)),!0;if(this.target==="hiddenAddVertex")return this.currentMode=this.Modes.EDIT_EDGE_MODE,this.addIntersectingVertex(t),t.stopPropagation(),t.preventDefault(),!1;this.currentMode=this.Modes.PAN_MODE,this.oldOffsetX=t.offsetX,this.oldOffsetY=t.offsetY},mouseupHandler(t){this.currentMode===this.Modes.ZOOM_MODE&&this.endZoomToSelection(t),!this.hasPanned&&this.currentMode===this.Modes.PAN_MODE&&!t.shiftKey&&this.currentEntryId&&this.currentEntryId!=="showAll"&&this.addPoint(t),this.hasPanned=!1,this.oldOffsetX=0,this.oldOffsetY=0,this.offsetX=0,this.mouseDown=!1,this.activePoint=-1,this.currentMode=this.Modes.VIEW_MODE},mousemoveHandler(t){if(this.currentMode===this.Modes.ZOOM_MODE){this.updateZoomSelectionRect(t);return}if(this.currentMode!==this.Modes.EDIT_EDGE_MODE){if(this.offsetX=t.offsetX,this.offsetY=t.offsetY,this.currentMode===this.Modes.MOVE_POINT){this.moveVertex(t);return}if(!this.hasPanned&&this.mouseDown){const e=M.getLineLength(t.offsetX,t.offsetY,this.oldOffsetX,this.oldOffsetY);this.delta=e,e>=this.panThreshold&&(this.hasPanned=!0,this.currentMode=this.Modes.PAN_MODE)}this.hasPanned&&this.mouseDown&&this.zoom!==1&&this.panViewport(t)}},setZoomMode(t){this.currentMode!==t?this.currentMode=t:this.currentMode=this.Modes.VIEW_MODE},getIntersectionForPoint(t,e,o){let r=this.points.length-1,n=new g(t,e);return this.points.findIndex((i,l,a)=>{let c=l-1;c<0&&(c=r);let m=new g(a[c][0],a[c][1]),d=new g(a[l][0],a[l][1]);return M.pointIntersectsLine(n,m,d,o)})},setImage(t){if(!this.images.length){this.img="";return}const o=this.images.find(n=>n.id===t).permalink;if(o===""){this.img="";return}let r=new Image;r.onload=n=>{const{offsetWidth:i,offsetHeight:l}=document.querySelector("div.transitionlayer");this.viewBox.width=n.target.naturalWidth,this.viewBox.height=n.target.naturalHeight,this.viewBox.factor=this.viewBox.width/i,this.viewBox.clientWidth=i,this.viewBox.clientHeight=l,this.height=2+this.viewBox.height/this.viewBox.factor},r.src=o,this.img=o,this.translateX=0,this.translateY=0,this.zoom=1,this.imgIsReady=!0},addPoint(t){const{clientWidth:e,clientHeight:o}=t.target.closest("div.transitionlayer"),r=this.viewBox.width/e,n=this.viewBox.height/o,i=t.offsetX*r,l=t.offsetY*n;this.points.push([i,l])},removePoint(t){let e=this.points;this.points.splice(t,1),this.points=e},addIntersectingVertex(t){t.stopPropagation(),t.preventDefault();const{clientWidth:e,clientHeight:o}=t.target.closest("div.transitionlayer"),r=this.viewBox.width/e,n=this.viewBox.height/o,i=t.offsetX*r,l=t.offsetY*n;let a=this.getIntersectionForPoint(i,l,10/this.zoom);a!=-1&&this.insertVertex(i,l,a)},insertVertex(t,e,o){if(o===this.points.length){this.points.push([t,e]);return}const r=this.points.slice(0,o),n=this.points.slice(o);r.push([t,e]),this.points=r.concat(n)},startMovePoint(t){this.activePoint=parseInt(t.target.getAttribute("idx"),10)},moveVertex(t){if(this.activePoint==-1)return;const{clientWidth:e,clientHeight:o}=t.target.closest("div.transitionlayer"),r=this.viewBox.width/e,n=this.viewBox.height/o,i=t.offsetX*r,l=t.offsetY*n;this.points[this.activePoint]=[i,l],this.points=this.points.slice(0)},panViewport(t){const{clientWidth:e,clientHeight:o}=t.target.closest("div.transitionlayer"),r=(t.offsetX-this.oldOffsetX)/this.zoom,n=(t.offsetY-this.oldOffsetY)/this.zoom;let i=Math.max(this.translateX+r,-e*this.zoom+e),l=Math.max(this.translateY+n,-o*this.zoom+o);this.translateX=Math.min(i,0),this.translateY=Math.min(l,0)},endPanZoomHandler(){this.activePoint=-1},setZoom(t,e,o){t>this.maxZoom||t<1||(this.zoom=t,this.translateX=e*t,this.translateY=o*t)},updateZoomSelectionRect(t){const{clientWidth:e,clientHeight:o}=t.target.closest("div.transitionlayer"),r=this.viewBox.width/e,n=this.viewBox.height/o,i=t.offsetX*r,l=t.offsetY*n;this.selection.x=i,this.selection.y=l,i<this.selection.startX?(this.selection.x=i,this.selection.width=this.selection.startX-i):(this.selection.x=this.selection.startX,this.selection.width=i-this.selection.startX),l<=this.selection.startY?(this.selection.y=l,this.selection.height=this.selection.startY-l):(this.selection.y=this.selection.startY,this.selection.height=l-this.selection.startY)},setSelectionZoom(t,e,o,r,n){const{clientWidth:i,clientHeight:l}=n.target.closest("div.transitionlayer"),a=this.viewBox.width/i,c=this.viewBox.height/l,m=Math.min(this.viewBox.width/o,this.viewBox.height/r);this.zoom*=m,this.translateX-=t/a*this.zoom,this.translateY-=e/c*this.zoom},endZoomToSelection(t){this.setSelectionZoom(this.selection.x,this.selection.y,this.selection.width,this.selection.height,t),this.selection={startX:0,startY:0,x:0,y:0,width:0,height:0},this.$emit("zoom-updated",!1)},startSelectionZoom(t){const{clientWidth:e,clientHeight:o}=t.target.closest("div.transitionlayer"),r=this.viewBox.width/e,n=this.viewBox.height/o,i=t.offsetX*r,l=t.offsetY*n;this.selection.startX=i,this.selection.startY=l,this.selection.x=i,this.selection.y=l},setWheelZoom(t){const{clientWidth:e,clientHeight:o}=t.target.closest("div.transitionlayer"),{offsetX:r,offsetY:n}=t,i=this.factor;let l=-t.deltaY/600;l=Math.max(-1,Math.min(1,l));let a=this.zoom;const c=r/a-this.translateX/a,m=n/a-this.translateY/a;a+=l*i*this.zoom,this.zoom=Math.max(1,Math.min(this.maxZoom,a)),a=this.zoom;let d={};d.x=-c*a+r,d.y=-m*a+n,d.x>0&&(d.x=0),d.x+e*a<e&&(d.x=-e*(a-1)),d.y>0&&(d.y=0),d.y+o*a<o&&(d.y=-o*(a-1)),this.translateX=d.x,this.translateY=d.y},vertexHover(t){t.shiftKey&&(this.hoveringVertex=!0)},stopVertexHover(){this.hoveringVertex=!1}}},N={class:"transitionlayer relative"},z=["viewBox"],H={fill:"rgba(64,0,128, .4)"},C=["points","stroke-width"],Z=["stroke-width","points"],A=["stroke-width","idx","r","cx","cy"],F=["x","y","width","height"],S={key:0},W=["id","stroke-width","points","fill","onClick"];function L(t,e,o,r,n,i){return o.selectedImage&&t.imgIsReady?(s.openBlock(),s.createElementBlock("div",{key:0,class:"m-0 p-0",style:s.normalizeStyle("height: "+this.height+"px"),id:"templateContainer"},[s.createElementVNode("div",N,[s.createElementVNode("div",{style:s.normalizeStyle(i.backgroundStyle),class:"svglayer relative"},[(s.openBlock(),s.createElementBlock("svg",{id:"svgElem",class:"fgsvg",version:"1.1",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",x:"0px",y:"0px",viewBox:i.viewboxStyle,"xml:space":"preserve",onWheelCapture:e[2]||(e[2]=s.withModifiers((...l)=>i.setWheelZoom&&i.setWheelZoom(...l),["prevent"])),onMousedown:e[3]||(e[3]=(...l)=>i.mousedownHandler&&i.mousedownHandler(...l)),onMousemove:e[4]||(e[4]=(...l)=>i.mousemoveHandler&&i.mousemoveHandler(...l)),onMouseup:e[5]||(e[5]=(...l)=>i.mouseupHandler&&i.mouseupHandler(...l))},[s.createElementVNode("g",H,[s.createElementVNode("polygon",{id:"resultPolygon",points:i.polygon,"stroke-width":2*t.viewBox.factor/t.zoom,style:{stroke:"#fc0a"}},null,8,C),s.createElementVNode("polygon",{id:"hiddenAddVertex","stroke-width":10*t.viewBox.factor/t.zoom,class:"polygonHelper",points:i.polygon,fill:"none",style:{stroke:"rgba(0,0,0,0)"}},null,8,Z),(s.openBlock(!0),s.createElementBlock(s.Fragment,null,s.renderList(t.points,(l,a)=>(s.openBlock(),s.createElementBlock("circle",{key:a,fill:"rgba(255,255,0, 0.1)","stroke-width":.707*t.viewBox.factor/t.zoom,stroke:"black",onMouseover:e[0]||(e[0]=(...c)=>i.vertexHover&&i.vertexHover(...c)),onMouseout:e[1]||(e[1]=(...c)=>i.stopVertexHover&&i.stopVertexHover(...c)),class:s.normalizeClass([{minusHover:t.hoveringVertex},"vertex"]),idx:a,r:4.8*t.viewBox.factor/t.zoom,cx:l[0],cy:l[1]},null,42,A))),128))]),s.createElementVNode("rect",{id:"zoomSelection",x:t.selection.x,y:t.selection.y,width:t.selection.width,height:t.selection.height,fill:"rgba(255,0,0,0.5)",style:{fill:"rgba(0,0,0,0.5)",stroke:"yellow","stroke-width":"1px","stroke-dasharray":"4"}},null,8,F),i.showAll?(s.openBlock(),s.createElementBlock("g",S,[(s.openBlock(!0),s.createElementBlock(s.Fragment,null,s.renderList(t.polygonCollection,(l,a)=>(s.openBlock(),s.createElementBlock("polygon",{id:l.entryId,key:l.entryId,"stroke-width":2*t.viewBox.factor/t.zoom,points:l.polygon,fill:i.randomFill(a),class:"allPolygons",onClick:c=>i.setActiveObjectDelegate(l.entryId)},null,8,W))),128))])):s.createCommentVNode("",!0)],40,z))],4)])],4)):s.createCommentVNode("",!0)}const T=y(D,[["render",L]]);Statamic.booting(()=>{Statamic.component("image_map_editor-fieldtype",X),Statamic.component("svg-edit",T)})})(Vue);
