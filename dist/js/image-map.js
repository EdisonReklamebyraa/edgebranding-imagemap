(function(){"use strict";function g(e,t,s,i,o,n,l,a){var r=typeof e=="function"?e.options:e;return t&&(r.render=t,r.staticRenderFns=s,r._compiled=!0),{exports:e,options:r}}const m={mixins:[Fieldtype],data(){return{zoom:!1,selectedDropdown:"showAll",entryMeta:[],loading:!1,polygons:[],images:[],selectedImage:null}},computed:{entriesWithMeta(){return this.value.entries.map(e=>this.entryMeta.find(t=>t.id===e))}},methods:{onImageUploaded(e){this.update({...this.value,images:e});let t=[];const s=this;Promise.all(e.map(i=>s.getImage(i))).then(i=>{i.forEach(o=>{t.push(o[0])}),s.images=t,s.selectedImage=t.length>0?t[0].id:null,s.updatePolygonList()})},onEntriesUpdated(e){this.update({...this.value,entries:e}),this.$nextTick(()=>{this.updatePolygonList()})},getImage(e){return this.$axios.post(cp_url("assets-fieldtype"),{assets:e}).then(t=>t.data)},activateZoomMode(){this.zoom=!this.zoom},updatePolygonList(){if(!this.value.entries){this.value.entries=[];return}const e=this.value.entries.flatMap(t=>{const s=this.entriesWithMeta.find(i=>i.id===t);return this.value.images.map(i=>{const o=this.value.items.find(n=>n.entryId===t&&n.assetId===i);return o||{entryId:t,assetId:i,label:s.title,polygon:""}})});this.update({...this.value,items:e}),this.polygons=e},updatePolygon(e){const t=this.value.items;let s=t.findIndex(i=>i.entryId===e.entryId&&i.assetId===e.assetId);t[s].polygon=e.polygon,this.update({...this.value,items:t})},updateZoom(e){this.zoom=e},loadEntryMeta(){const e={config:btoa(JSON.stringify({handle:"collections",type:"entries",collections:this.config.collections,mode:"tags"})),value:this.value.entries};this.loading=!0,this.$axios.get(cp_url("fields/field-meta"),{params:e}).then(t=>{this.entryMeta=t.data.meta.data,this.loading=!1,this.updatePolygonList()})}},mounted(){this.loadEntryMeta(),this.value.items||this.update({...this.value,items:[]})}};var p=function(){var t=this,s=t._self._c;return s("div",[s("div",{staticClass:"flex flex-wrap gap-1"},[s("publish-field-meta",{staticClass:"w-1/2 mr-2 assets-fieldtype",attrs:{config:{type:"assets"},"initial-value":t.value.images,"initial-meta":{container:t.config.container}},scopedSlots:t._u([{key:"default",fn:function({meta:i,value:o,loading:n}){return s("div",{},[s("label",{staticClass:"publish-field-label mb-1"},[s("span",{staticClass:"cursor-pointer"},[t._v("Image")])]),n?t._e():s("assets-fieldtype",{ref:"asset",attrs:{config:{container:t.config.container,mode:"grid",allow_uploads:!0,type:"assets",display:"assets",component:"assets",handle:"assets"},value:o,meta:i,handle:"asset"},on:{input:t.onImageUploaded}})],1)}}])}),s("publish-field-meta",{staticClass:"w-1/2 flex-1",attrs:{config:{handle:"collections",type:"entries",collections:t.config.collections,mode:"tags"},"initial-value":t.value.entries},scopedSlots:t._u([{key:"default",fn:function({meta:i,value:o,loading:n}){return s("div",{},[s("label",{staticClass:"publish-field-label mb-1"},[s("span",{staticClass:"cursor-pointer",domProps:{innerHTML:t._s(t.__("Buildings"))}})]),n?t._e():s("relationship-fieldtype",{ref:"entry",attrs:{config:{handle:"collections",type:"entries",collections:t.config.collections,mode:"tags"},value:o,meta:i,handle:"entry"},on:{input:t.onEntriesUpdated,"meta-updated":function(l){i.data=l.data,t.entryMeta=l.data}}})],1)}}])})],1),t.loading?t._e():s("div",{staticClass:"imagemapeditor mx-auto w-full mt-4"},[s("label",{staticClass:"publish-field-label mb-1"},[s("span",{staticClass:"cursor-pointer",domProps:{innerHTML:t._s(t.__("Editor"))}})]),s("div",{staticClass:"flex"},[s("div",{staticClass:"flex-initial control mb-1 mr-1 field select-input"},[s("button",{staticClass:"btn",class:t.zoom?"btn-primary":"",domProps:{innerHTML:t._s(t.__("Forstørr område"))},on:{click:function(i){return t.activateZoomMode()}}})]),s("v-select",{staticClass:"w-full mr-1",attrs:{options:t.images.map(i=>i===void 0?null:{value:i.id,label:i.values.alt||i.filename}).filter(i=>i!==null),reduce:i=>i.value,clearable:!1},model:{value:t.selectedImage,callback:function(i){t.selectedImage=i},expression:"selectedImage"}}),s("v-select",{staticClass:"w-full",attrs:{options:[{value:"showAll",label:t.__("Velg eiendom / vis alle")}].concat(t.entriesWithMeta.map(i=>i===void 0?null:{value:i.id,label:i.title}).filter(i=>i!==null)),reduce:i=>i.value,clearable:!1},model:{value:t.selectedDropdown,callback:function(i){t.selectedDropdown=i},expression:"selectedDropdown"}})],1),s("div",{attrs:{id:"editor"}},[t.polygons.length&&t.images.length>0?s("svg-edit",{attrs:{selected:t.selectedDropdown,polygons:t.polygons,"zoom-enabled":t.zoom,images:t.images,"selected-image":t.selectedImage},on:{"polygon-updated":t.updatePolygon,"zoom-updated":t.updateZoom,"update:selected":function(i){t.selectedDropdown=i}}}):t._e()],1)])])},y=[],x=g(m,p,y);const v=x.exports;class d{constructor(t,s){this.x=t,this.y=s}}class M{getLineLength(t,s,i,o){return Math.sqrt((i-t)**2+(o-s)**2)}getAngle(t,s){const i=s.x-t.x,o=s.y-t.y;let n=Math.atan2(-o,i);return n<0&&(n+=2*Math.PI),n}rotate(t,s,i){const o=Math.cos(i),n=Math.sin(i);let l=s.x*o-s.y*n,a=s.y*o+s.x*n;return new d(l,a)}pointIntersectsLine(t,s,i,o){const n=new d(0,0),l=this.getAngle(s,i),a=this.rotate(n,i,l),r=this.rotate(n,s,l),c=this.rotate(n,t,l);return c.x<=Math.max(r.x,a.x)&&c.x>=Math.min(r.x,a.x)&&c.y<=r.y+o/2&&c.y>=a.y-o/2}}const f=new M,u={VIEW_MODE:0,PAN_MODE:1,BEFORE_ZOOM_MODE:2,ZOOM_MODE:3,MOVE_POINT:4,EDIT_EDGE_MODE:5};Object.freeze(u);const w=Vue.extend({watch:{polygon(){if(!this.currentEntryId)return;this.polygonCollection[this.currentEntryId].polygon=this.polygon;const e={entryId:this.currentEntryId,assetId:this.selectedImage,polygon:this.polygon};this.$emit("polygon-updated",e)},zoomEnabled(){this.zoomEnabled?this.setZoomMode(this.Modes.BEFORE_ZOOM_MODE):this.setZoomMode(this.Modes.VIEW_MODE)},selected(){this.setActiveObject(this.selected)},selectedImage(){this.setPolygonCollection(),this.setActiveObject(this.selected),!(!this.images.length>0)&&this.setImage(this.selectedImage)},images(){this.setPolygonCollection(),this.setActiveObject(this.selected),!(!this.images.length>0)&&this.setImage(this.selectedImage)}},mounted(){window.addEventListener("keyup",this.keyHandler),this.setImage(this.selectedImage),this.setPolygonCollection(),this.setActiveObject(this.selected)},name:"SvgEdit",props:{images:String,selectedImage:String,zoomEnabled:Boolean,selected:String,polygons:Array},computed:{viewboxStyle(){return`0 0 ${this.viewBox.width} ${this.viewBox.height} `},backgroundStyle(){let e=`transform: translateX(${this.translateX}px) `;return e+=`translateY(${this.translateY}px) scale(${this.zoom});`,e+=`background-image: url(${this.img})`,e},polygon(){return this.points.map(e=>e.join(",")).join(" ")},getCurrentMode(){return parseInt(this.currentMode,10)},showAll(){return this.currentEntryId==="showAll"||!this.currentEntryId}},data:function(){return{currentFill:0,fills:["rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)","rgba(127,0,0,0.5)"],img:"",imgIsReady:!1,viewBox:{factor:1,width:0,height:0},mouseDown:!1,delta:0,hasPanned:!1,panThreshold:8,target:null,Modes:u,currentMode:u.VIEW_MODE,activePoint:-1,selection:{startX:0,startY:0,x:0,y:0,width:0,height:0},factor:.8,oldOffsetX:0,oldOffsetY:0,offsetX:0,offsetY:0,points:[],maxZoom:5,translateX:0,translateY:0,zoom:1,hoveringVertex:!1,polygonCollection:{},currentEntryId:null,height:0}},methods:{setPolygonCollection(){let e={};this.polygons.filter(t=>t.assetId===this.selectedImage).map(t=>{e[t.entryId]=t}),this.polygonCollection=e},randomFill(e){let t=Object.keys(this.polygonCollection).indexOf(e);for(t===-1&&(t=0);t>this.fills.length-1;)t=t-this.fills.length;return this.fills[t]},setActiveObjectDelegate(e){this.currentMode!==this.Modes.PAN_MODE&&this.setActiveObject(e)},setActiveObject(e){if(e==="showAll"){this.currentEntryId=null,this.points=[];return}if(this.currentEntryId=e,this.polygonCollection[e]||(this.polygonCollection[e]={}),this.polygonCollection[e].polygon){let t=this.polygonCollection[e].polygon;t=t.split(" ").map(s=>s.split(",")),this.points=t}else this.points=[];this.$emit("update:selected",this.currentEntryId)},keyHandler(e){e.key==="z"&&(this.currentMode=this.Modes.BEFORE_ZOOM_MODE)},mousedownHandler(e){if(this.mouseDown=!0,this.currentMode===this.Modes.BEFORE_ZOOM_MODE){this.currentMode=this.Modes.ZOOM_MODE,this.startSelectionZoom(e);return}if(e.target.tagName==="circle"?this.target="circle":this.target=e.target.getAttribute("id"),this.target==="circle")return e.shiftKey?this.removePoint(e.target.getAttribute("idx")):(this.currentMode=this.Modes.MOVE_POINT,this.startMovePoint(e)),!0;if(this.target==="hiddenAddVertex")return this.currentMode=this.Modes.EDIT_EDGE_MODE,this.addIntersectingVertex(e),e.stopPropagation(),e.preventDefault(),!1;this.currentMode=this.Modes.PAN_MODE,this.oldOffsetX=e.offsetX,this.oldOffsetY=e.offsetY},mouseupHandler(e){this.currentMode===this.Modes.ZOOM_MODE&&this.endZoomToSelection(e),!this.hasPanned&&this.currentMode===this.Modes.PAN_MODE&&!e.shiftKey&&this.currentEntryId&&this.currentEntryId!=="showAll"&&this.addPoint(e),this.hasPanned=!1,this.oldOffsetX=0,this.oldOffsetY=0,this.offsetX=0,this.mouseDown=!1,this.activePoint=-1,this.currentMode=this.Modes.VIEW_MODE},mousemoveHandler(e){if(this.currentMode===this.Modes.ZOOM_MODE){this.updateZoomSelectionRect(e);return}if(this.currentMode!==this.Modes.EDIT_EDGE_MODE){if(this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.currentMode===this.Modes.MOVE_POINT){this.moveVertex(e);return}if(!this.hasPanned&&this.mouseDown){const t=f.getLineLength(e.offsetX,e.offsetY,this.oldOffsetX,this.oldOffsetY);this.delta=t,t>=this.panThreshold&&(this.hasPanned=!0,this.currentMode=this.Modes.PAN_MODE)}this.hasPanned&&this.mouseDown&&this.zoom!==1&&this.panViewport(e)}},setZoomMode(e){this.currentMode!==e?this.currentMode=e:this.currentMode=this.Modes.VIEW_MODE},getIntersectionForPoint(e,t,s){let i=this.points.length-1,o=new d(e,t);return this.points.findIndex((n,l,a)=>{let r=l-1;r<0&&(r=i);let c=new d(a[r][0],a[r][1]),h=new d(a[l][0],a[l][1]);return f.pointIntersectsLine(o,c,h,s)})},setImage(e){if(!this.images.length){this.img="";return}const s=this.images.find(o=>o.id===e).permalink;if(s===""){this.img="";return}let i=new Image;i.onload=o=>{const{offsetWidth:n,offsetHeight:l}=document.querySelector("div.transitionlayer");this.viewBox.width=o.target.naturalWidth,this.viewBox.height=o.target.naturalHeight,this.viewBox.factor=this.viewBox.width/n,this.viewBox.clientWidth=n,this.viewBox.clientHeight=l,this.height=2+this.viewBox.height/this.viewBox.factor},i.src=s,this.img=s,this.translateX=0,this.translateY=0,this.zoom=1,this.imgIsReady=!0},addPoint(e){const{clientWidth:t,clientHeight:s}=e.target.closest("div.transitionlayer"),i=this.viewBox.width/t,o=this.viewBox.height/s,n=e.offsetX*i,l=e.offsetY*o;this.points.push([n,l])},removePoint(e){let t=this.points;this.points.splice(e,1),this.points=t},addIntersectingVertex(e){e.stopPropagation(),e.preventDefault();const{clientWidth:t,clientHeight:s}=e.target.closest("div.transitionlayer"),i=this.viewBox.width/t,o=this.viewBox.height/s,n=e.offsetX*i,l=e.offsetY*o;let a=this.getIntersectionForPoint(n,l,10/this.zoom);a!=-1&&this.insertVertex(n,l,a)},insertVertex(e,t,s){if(s===this.points.length){this.points.push([e,t]);return}const i=this.points.slice(0,s),o=this.points.slice(s);i.push([e,t]),this.points=i.concat(o)},startMovePoint(e){this.activePoint=parseInt(e.target.getAttribute("idx"),10)},moveVertex(e){if(this.activePoint==-1)return;const{clientWidth:t,clientHeight:s}=e.target.closest("div.transitionlayer"),i=this.viewBox.width/t,o=this.viewBox.height/s,n=e.offsetX*i,l=e.offsetY*o;this.points[this.activePoint]=[n,l],this.points=this.points.slice(0)},panViewport(e){const{clientWidth:t,clientHeight:s}=e.target.closest("div.transitionlayer"),i=(e.offsetX-this.oldOffsetX)/this.zoom,o=(e.offsetY-this.oldOffsetY)/this.zoom;let n=Math.max(this.translateX+i,-t*this.zoom+t),l=Math.max(this.translateY+o,-s*this.zoom+s);this.translateX=Math.min(n,0),this.translateY=Math.min(l,0)},endPanZoomHandler(){this.activePoint=-1},setZoom(e,t,s){e>this.maxZoom||e<1||(this.zoom=e,this.translateX=t*e,this.translateY=s*e)},updateZoomSelectionRect(e){const{clientWidth:t,clientHeight:s}=e.target.closest("div.transitionlayer"),i=this.viewBox.width/t,o=this.viewBox.height/s,n=e.offsetX*i,l=e.offsetY*o;this.selection.x=n,this.selection.y=l,n<this.selection.startX?(this.selection.x=n,this.selection.width=this.selection.startX-n):(this.selection.x=this.selection.startX,this.selection.width=n-this.selection.startX),l<=this.selection.startY?(this.selection.y=l,this.selection.height=this.selection.startY-l):(this.selection.y=this.selection.startY,this.selection.height=l-this.selection.startY)},setSelectionZoom(e,t,s,i,o){const{clientWidth:n,clientHeight:l}=o.target.closest("div.transitionlayer"),a=this.viewBox.width/n,r=this.viewBox.height/l,c=Math.min(this.viewBox.width/s,this.viewBox.height/i);this.zoom*=c,this.translateX-=e/a*this.zoom,this.translateY-=t/r*this.zoom},endZoomToSelection(e){this.setSelectionZoom(this.selection.x,this.selection.y,this.selection.width,this.selection.height,e),this.selection={startX:0,startY:0,x:0,y:0,width:0,height:0},this.$emit("zoom-updated",!1)},startSelectionZoom(e){const{clientWidth:t,clientHeight:s}=e.target.closest("div.transitionlayer"),i=this.viewBox.width/t,o=this.viewBox.height/s,n=e.offsetX*i,l=e.offsetY*o;this.selection.startX=n,this.selection.startY=l,this.selection.x=n,this.selection.y=l},setWheelZoom(e){const{clientWidth:t,clientHeight:s}=e.target.closest("div.transitionlayer"),{offsetX:i,offsetY:o}=e,n=this.factor;let l=-e.deltaY/600;l=Math.max(-1,Math.min(1,l));let a=this.zoom;const r=i/a-this.translateX/a,c=o/a-this.translateY/a;a+=l*n*this.zoom,this.zoom=Math.max(1,Math.min(this.maxZoom,a)),a=this.zoom;let h={};h.x=-r*a+i,h.y=-c*a+o,h.x>0&&(h.x=0),h.x+t*a<t&&(h.x=-t*(a-1)),h.y>0&&(h.y=0),h.y+s*a<s&&(h.y=-s*(a-1)),this.translateX=h.x,this.translateY=h.y},vertexHover(e){e.shiftKey&&(this.hoveringVertex=!0)},stopVertexHover(){this.hoveringVertex=!1}}});var _=function(){var t=this,s=t._self._c;return t._self._setupProxy,t.selectedImage&&t.imgIsReady?s("div",{staticClass:"m-0 p-0",style:"height: "+this.height+"px",attrs:{id:"templateContainer"}},[s("div",{staticClass:"transitionlayer relative"},[s("div",{staticClass:"svglayer relative",style:t.backgroundStyle},[s("svg",{staticClass:"fgsvg",attrs:{id:"svgElem",version:"1.1",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",x:"0px",y:"0px",viewBox:t.viewboxStyle,"xml:space":"preserve"},on:{"!wheel":function(i){return i.preventDefault(),t.setWheelZoom.apply(null,arguments)},mousedown:t.mousedownHandler,mousemove:t.mousemoveHandler,mouseup:t.mouseupHandler}},[s("g",{attrs:{fill:"rgba(64,0,128, .4)"}},[s("polygon",{staticStyle:{stroke:"#fc0a"},attrs:{id:"resultPolygon",points:t.polygon,"stroke-width":2*t.viewBox.factor/t.zoom}}),s("polygon",{staticClass:"polygonHelper",staticStyle:{stroke:"rgba(0,0,0,0)"},attrs:{id:"hiddenAddVertex","stroke-width":10*t.viewBox.factor/t.zoom,points:t.polygon,fill:"none"}}),t._l(t.points,function(i,o){return s("circle",{key:o,staticClass:"vertex",class:{minusHover:t.hoveringVertex},attrs:{fill:"rgba(255,255,0, 0.1)","stroke-width":.707*t.viewBox.factor/t.zoom,stroke:"black",idx:o,r:4.8*t.viewBox.factor/t.zoom,cx:i[0],cy:i[1]},on:{mouseover:t.vertexHover,mouseout:t.stopVertexHover}})})],2),s("rect",{staticStyle:{fill:"rgba(0,0,0,0.5)",stroke:"yellow","stroke-width":"1px","stroke-dasharray":"4"},attrs:{id:"zoomSelection",x:t.selection.x,y:t.selection.y,width:t.selection.width,height:t.selection.height,fill:"rgba(255,0,0,0.5)"}}),t.showAll?s("g",t._l(t.polygonCollection,function(i,o){return s("polygon",{key:i.entryId,staticClass:"allPolygons",attrs:{id:i.entryId,"stroke-width":2*t.viewBox.factor/t.zoom,points:i.polygon,fill:t.randomFill(o)},on:{click:function(n){return t.setActiveObjectDelegate(i.entryId)}}})}),0):t._e()])])])]):t._e()},I=[],O=g(w,_,I);const E=O.exports;Statamic.booting(()=>{Statamic.component("image_map_editor-fieldtype",v),Vue.component("svg-edit",E)})})();
